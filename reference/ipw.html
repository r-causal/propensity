<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Inverse Probability Weights for Causal Inference — ipw • propensity</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Inverse Probability Weights for Causal Inference — ipw"><meta name="description" content="ipw() is a bring-your-own-model (BYOM) inverse probability weighted
estimator. ipw() accepts a propensity score model and a weighted outcome
model that you have already fit. The purpose of ipw() is to capture the
uncertainty inherent to this two-step process and calculate the correct
standard errors for each estimate. Currently, ipw() supports binary
exposures and either binary or continuous outcomes. For binary outcomes,
ipw() calculates the marginal risk difference, log risk ratio, and log odds
ratio. For continuous outcomes, ipw() only calculates the marginal
difference in means."><meta property="og:description" content="ipw() is a bring-your-own-model (BYOM) inverse probability weighted
estimator. ipw() accepts a propensity score model and a weighted outcome
model that you have already fit. The purpose of ipw() is to capture the
uncertainty inherent to this two-step process and calculate the correct
standard errors for each estimate. Currently, ipw() supports binary
exposures and either binary or continuous outcomes. For binary outcomes,
ipw() calculates the marginal risk difference, log risk ratio, and log odds
ratio. For continuous outcomes, ipw() only calculates the marginal
difference in means."><meta property="og:image" content="https://r-causal.github.io/propensity/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">propensity</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/malcolmbarrett/propensity/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Inverse Probability Weights for Causal Inference</h1>
      <small class="dont-index">Source: <a href="https://github.com/malcolmbarrett/propensity/blob/main/R/ipw.R" class="external-link"><code>R/ipw.R</code></a></small>
      <div class="d-none name"><code>ipw.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>ipw()</code> is a bring-your-own-model (BYOM) inverse probability weighted
estimator. <code>ipw()</code> accepts a propensity score model and a weighted outcome
model that you have already fit. The purpose of <code>ipw()</code> is to capture the
uncertainty inherent to this two-step process and calculate the correct
standard errors for each estimate. Currently, <code>ipw()</code> supports binary
exposures and either binary or continuous outcomes. For binary outcomes,
<code>ipw()</code> calculates the marginal risk difference, log risk ratio, and log odds
ratio. For continuous outcomes, <code>ipw()</code> only calculates the marginal
difference in means.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">ipw</span><span class="op">(</span></span>
<span>  <span class="va">ps_mod</span>,</span>
<span>  <span class="va">outcome_mod</span>,</span>
<span>  .df <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  estimand <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ps_link <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  conf_level <span class="op">=</span> <span class="fl">0.95</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'ipw'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">x</span>, row.names <span class="op">=</span> <span class="cn">NULL</span>, optional <span class="op">=</span> <span class="cn">NULL</span>, exponentiate <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-ps-mod">ps_mod<a class="anchor" aria-label="anchor" href="#arg-ps-mod"></a></dt>
<dd><p>A fitted propensity score model of class <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code>,
typically a logistic regression with the exposure as the dependent
variable.</p></dd>


<dt id="arg-outcome-mod">outcome_mod<a class="anchor" aria-label="anchor" href="#arg-outcome-mod"></a></dt>
<dd><p>A fitted, weighted outcome model of class <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code>
or <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm()</a></code>, with the outcome as the dependent variable.</p></dd>


<dt id="arg--df">.df<a class="anchor" aria-label="anchor" href="#arg--df"></a></dt>
<dd><p>A data frame containing the exposure, outcome, and covariates. If
<code>NULL</code>, <code>ipw()</code> will try to extract the data from <code>ps_mod</code> and
<code>outcome_mod</code>.</p></dd>


<dt id="arg-estimand">estimand<a class="anchor" aria-label="anchor" href="#arg-estimand"></a></dt>
<dd><p>A character string specifying the causal estimand: <code>ate</code>,
<code>att</code>, <code>ato</code>, or <code>atm</code>. If <code>NULL</code>, the function attempts to infer it from
existing weights in <code>outcome_mod</code>, assuming the were calculated with
<code><a href="wt_ate.html">wt_ate()</a></code>, <code><a href="wt_ate.html">wt_att()</a></code>, <code><a href="wt_ate.html">wt_atm()</a></code>, or <code><a href="wt_ate.html">wt_ato()</a></code>.</p></dd>


<dt id="arg-ps-link">ps_link<a class="anchor" aria-label="anchor" href="#arg-ps-link"></a></dt>
<dd><p>A character string specifying the link function for the
propensity score model: <code>logit</code>, <code>probit</code>, or <code>cloglog</code>. Defaults to
whatever link was used by <code>ps_mod</code>.</p></dd>


<dt id="arg-conf-level">conf_level<a class="anchor" aria-label="anchor" href="#arg-conf-level"></a></dt>
<dd><p>Numeric. Confidence level for intervals (default <code>0.95</code>).</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>an <code>ipw</code> object</p></dd>


<dt id="arg-row-names-optional-">row.names, optional, ...<a class="anchor" aria-label="anchor" href="#arg-row-names-optional-"></a></dt>
<dd><p>Passed to <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code>.</p></dd>


<dt id="arg-exponentiate">exponentiate<a class="anchor" aria-label="anchor" href="#arg-exponentiate"></a></dt>
<dd><p>Logical. Should the log-RR and log-OR be exponentiated?</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An S3 object of class <code>ipw</code> containing:</p><ul><li><p><code>estimand</code>: One of <code>"ate"</code>, <code>"att"</code>, <code>"ato"</code>, or <code>"atm"</code>.</p></li>
<li><p><code>ps_mod</code>: The fitted propensity score model.</p></li>
<li><p><code>outcome_mod</code>: The fitted outcome model.</p></li>
<li><p><code>estimates</code>: A data frame of point estimates, standard errors, z-statistics,
confidence intervals, and p-values.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function constructs inverse probability weights based on the
chosen <code>estimand</code>, then uses these weights (or extracts them from
<code>outcome_mod</code>) to compute effect measures:</p><ul><li><p><code>rd</code>: Risk difference</p></li>
<li><p><code>log(rr)</code>: Log risk ratio</p></li>
<li><p><code>log(or)</code>: Log odds ratio</p>
<p>For a linear outcome model (using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm()</a></code> or <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code> with
<code>family = gaussian()</code>), only the difference in means (<code>diff</code>) is returned.</p></li>
</ul><p><strong>Variance Estimation</strong></p>
<p>The variance is estimated via linearization, which provide variance
estimates for IPW that correctly account for the uncertainty in estimation
of the propensity scores. For more details on various types of propensity
score weights and their corresponding variance estimators, see:</p><ul><li><p><em>Kostouraki A, Hajage D, Rachet B, et al. On variance estimation of the inverse
probability-of-treatment weighting estimator: A tutorial for different
types of propensity score weights. Statistics in Medicine. 2024; 43(13):
2672-2694. doi: <a href="https://doi.org/10.1002/sim.10078" class="external-link">10.1002/sim.10078</a></em></p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm()</a></code>, <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm()</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></span>
<span class="r-in"><span><span class="co"># confounder</span></span></span>
<span class="r-in"><span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># exposure</span></span></span>
<span class="r-in"><span><span class="va">z</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fl">0.2</span> <span class="op">*</span> <span class="va">x1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># binary outcome</span></span></span>
<span class="r-in"><span><span class="va">y</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">z</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">z</span>, <span class="va">y</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># fit a propensity score model (exposure ~ x1)</span></span></span>
<span class="r-in"><span><span class="va">ps_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">z</span> <span class="op">~</span> <span class="va">x1</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># calculate weights for ATE</span></span></span>
<span class="r-in"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ps_mod</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="wt_ate.html">wt_ate</a></span><span class="op">(</span><span class="va">ps</span>, <span class="va">z</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Treating `.exposure` as binary</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Setting treatment to `1`</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># fit an outcome model (binary y ~ z) using IPW</span></span></span>
<span class="r-in"><span><span class="va">outcome_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>, weights <span class="op">=</span> <span class="va">wts</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>non-integer #successes in a binomial glm!</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># run IPW</span></span></span>
<span class="r-in"><span><span class="va">ipw_res</span> <span class="op">&lt;-</span> <span class="fu">ipw</span><span class="op">(</span><span class="va">ps_mod</span>, <span class="va">outcome_mod</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">ipw_res</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Inverse Probability Weight Estimator</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Estimand: ATE </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Propensity Score Model:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Call: glm(formula = z ~ x1, family = binomial(), data = dat) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Outcome Model:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Call: glm(formula = y ~ z, family = binomial(), data = dat, weights = wts) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         estimate  std.err        z ci.lower ci.upper conf.level   p.value    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> rd       0.16311 0.076670 2.127466   0.0128  0.31338       0.95   0.03338 *  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> log(rr)  0.19720 0.080683 2.444134   0.0391  0.35533       0.95   0.01452 *  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> log(or)  1.24122 0.170217 7.291963   0.9076  1.57484       0.95 3.055e-13 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Convert to a data frame with exponentiated RR/OR</span></span></span>
<span class="r-in"><span><span class="va">ipw_res_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">ipw_res</span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">ipw_res_df</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   effect  estimate    std.err        z   ci.lower  ci.upper conf.level</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1     rd 0.1631125 0.07666988 2.127466 0.01284233 0.3133827       0.95</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2     rr 1.2179865 0.08068260 2.444134 1.03983716 1.4266572       0.95</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3     or 3.4598274 0.17021737 7.291963 2.47836430 4.8299620       0.95</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        p.value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 3.338141e-02</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 1.452002e-02</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 3.055334e-13</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Malcolm Barrett.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

